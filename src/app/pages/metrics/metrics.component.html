<div class="metrics-container">
  <div class="metrics-header">
    <h1 class="metrics-title">åœ–åƒå“è³ªæŒ‡æ¨™è¦–è¦ºåŒ–å„€è¡¨æ¿</h1>
    <p class="metrics-subtitle">Image Quality Metrics Visualization Dashboard</p>
  </div>

  <!-- Data Upload Section -->
  <div class="data-upload-section">
    <p-fileUpload
        mode="basic"
        chooseLabel="ä¸Šå‚³ JSON æ•¸æ“š / Upload JSON Data"
        chooseIcon="pi pi-upload"
        accept=".json"
        maxFileSize="5000000"
        [customUpload]="true"
        (uploadHandler)="onUpload($event)"
        [auto]="true"
        styleClass="p-button-help p-button-lg w-full md:w-auto">
    </p-fileUpload>
  </div>

  <!-- View Mode Toggle -->
  <div class="view-toggle" *ngIf="!loading && metrics.length > 0">
    <p-selectButton
      [options]="viewOptions"
      [(ngModel)]="viewMode"
      optionLabel="label"
      optionValue="value">
    </p-selectButton>
    <div class="action-buttons">
      <p-button
        label="Clear All Data"
        icon="pi pi-trash"
        (onClick)="clearData()"
        styleClass="p-button-danger p-button-outlined mr-2">
      </p-button>
      <p-button
        *ngIf="showCharts()"
        label="Export All Charts"
        icon="pi pi-download"
        (onClick)="exportAllCharts()"
        styleClass="p-button-outlined export-all-btn">
      </p-button>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="metrics-charts" *ngIf="showCharts() && !loading && metrics.length > 0">
    
    <!-- 1ï¸âƒ£ Area Chart - Higher is Better -->
    <div class="area-chart-container" *ngIf="higherBetterAreaChartData">
      <p-card header="ğŸ“ˆ Higher is Better Metrics (PSNR & SSIM) â†‘" styleClass="metrics-card area-card">
        <p class="chart-description">
          é¢ç©è¶Šå¤§è¶Šå¥½ | Larger area indicates better performance
        </p>
        <div class="chart-container area-chart">
          <p-chart type="line" [data]="higherBetterAreaChartData" [options]="higherBetterAreaChartOptions"></p-chart>
        </div>
      </p-card>
    </div>

    <!-- 2ï¸âƒ£ Radar Chart - Image Quality -->
    <div class="radar-chart-container" *ngIf="radarChartData">
      <p-card header="ğŸ–¼ï¸ Image Quality Metrics" styleClass="metrics-card radar-card">
        <p class="radar-description">
          ğŸŸ¢ è¶Šæ¥è¿‘å¤–åœˆè¶Šå¥½ | Closer to outer ring is better (å·²è½‰æ›ç‚ºèƒ½åŠ›åˆ†æ•¸)
        </p>
        <div class="chart-container radar-chart">
          <p-chart type="radar" [data]="radarChartData" [options]="radarChartOptions"></p-chart>
        </div>
      </p-card>
    </div>

    <!-- 3ï¸âƒ£ Radar Chart - Color Accuracy (vs Original) -->
    <div class="radar-chart-container" *ngIf="radarColorOriginalChartData">
      <p-card header="ğŸ¨ Color Accuracy (vs Original)" styleClass="metrics-card radar-card">
        <p class="radar-description">
          ğŸŸ¢ è¶Šæ¥è¿‘å¤–åœˆè¶Šå¥½ | Closer to outer ring is better (å·²è½‰æ›ç‚ºèƒ½åŠ›åˆ†æ•¸)
        </p>
        <div class="chart-container radar-chart">
          <p-chart type="radar" [data]="radarColorOriginalChartData" [options]="radarChartOptions"></p-chart>
        </div>
      </p-card>
    </div>

    <!-- 4ï¸âƒ£ Radar Chart - Color Accuracy (vs Reference) -->
    <div class="radar-chart-container" *ngIf="radarColorReferenceChartData">
      <p-card header="ğŸ¨ Color Accuracy (vs Reference)" styleClass="metrics-card radar-card">
        <p class="radar-description">
          ğŸŸ¢ è¶Šæ¥è¿‘å¤–åœˆè¶Šå¥½ | Closer to outer ring is better (å·²è½‰æ›ç‚ºèƒ½åŠ›åˆ†æ•¸)
        </p>
        <div class="chart-container radar-chart">
          <p-chart type="radar" [data]="radarColorReferenceChartData" [options]="radarChartOptions"></p-chart>
        </div>
      </p-card>
    </div>

    <!-- Bar Charts Grid -->
    <h3 class="charts-section-title">ğŸ“Š Individual Metrics Comparison</h3>
    <div class="charts-grid">
      <!-- Higher is Better Metrics -->
      <p-card *ngIf="psnrChartData" header="PSNR (Higher is Better) â†‘" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="psnrChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <p-card *ngIf="ssimChartData" header="SSIM (Higher is Better) â†‘" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="ssimChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <!-- Lower is Better Metrics -->
      <p-card *ngIf="niqeChartData" header="NIQE (Lower is Better) â†“" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="niqeChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <p-card *ngIf="brisqueChartData" header="BRISQUE (Lower is Better) â†“" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="brisqueChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <p-card *ngIf="loeChartData" header="LOE (Lower is Better) â†“" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="loeChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <p-card *ngIf="lpipsChartData" header="LPIPS (Lower is Better) â†“" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="lpipsChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <!-- Delta E Metrics -->
      <p-card *ngIf="deltaE76OriginalChartData" header="Delta E76 vs Original (Lower is Better) â†“" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="deltaE76OriginalChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <p-card *ngIf="deltaE76ReferenceChartData" header="Delta E76 vs Reference (Lower is Better) â†“" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="deltaE76ReferenceChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <!-- CIEDE2000 Metrics -->
      <p-card *ngIf="ciede2000OriginalChartData" header="CIEDE2000 vs Original (Lower is Better) â†“" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="ciede2000OriginalChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <p-card *ngIf="ciede2000ReferenceChartData" header="CIEDE2000 vs Reference (Lower is Better) â†“" styleClass="metrics-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="ciede2000ReferenceChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <!-- Angular Error Metrics (Critical for HSV method) -->
      <p-card *ngIf="angularErrorOriginalChartData" header="Angular Error vs Original (Lower is Better) â†“ ğŸ”‘" styleClass="metrics-card highlight-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="angularErrorOriginalChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>

      <p-card *ngIf="angularErrorReferenceChartData" header="Angular Error vs Reference (Lower is Better) â†“ ğŸ”‘" styleClass="metrics-card highlight-card">
        <div class="chart-container">
          <p-chart type="bar" [data]="angularErrorReferenceChartData" [options]="chartOptions"></p-chart>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Tables Section -->
  <div class="metrics-content" *ngIf="showTable() && !loading && metrics.length > 0">
    <p-card header="Model Comparison Overview (Averaged)" styleClass="metrics-card">
      <p-table [value]="averagedMetrics" [tableStyle]="{ 'min-width': '50rem' }" sortMode="multiple">
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="model">Model <p-sortIcon field="model"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('niqe')" pSortableColumn="metrics.niqe">NIQE (Avg) â†“ <p-sortIcon field="metrics.niqe"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('brisque')" pSortableColumn="metrics.brisque">BRISQUE (Avg) â†“ <p-sortIcon field="metrics.brisque"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('loe')" pSortableColumn="metrics.loe">LOE (Avg) â†“ <p-sortIcon field="metrics.loe"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('psnr')" pSortableColumn="metrics.psnr">PSNR (Avg) â†‘ <p-sortIcon field="metrics.psnr"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('ssim')" pSortableColumn="metrics.ssim">SSIM (Avg) â†‘ <p-sortIcon field="metrics.ssim"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('lpips')" pSortableColumn="metrics.lpips">LPIPS (Avg) â†“ <p-sortIcon field="metrics.lpips"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('delta_e76_vs_original')" pSortableColumn="metrics.delta_e76_vs_original.mean">Delta E76 vs Orig (Avg) â†“ <p-sortIcon field="metrics.delta_e76_vs_original.mean"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('delta_e76_vs_reference')" pSortableColumn="metrics.delta_e76_vs_reference.mean">Delta E76 vs Ref (Avg) â†“ <p-sortIcon field="metrics.delta_e76_vs_reference.mean"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('ciede2000_vs_original')" pSortableColumn="metrics.ciede2000_vs_original.mean">CIEDE2000 vs Orig (Avg) â†“ <p-sortIcon field="metrics.ciede2000_vs_original.mean"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('ciede2000_vs_reference')" pSortableColumn="metrics.ciede2000_vs_reference.mean">CIEDE2000 vs Ref (Avg) â†“ <p-sortIcon field="metrics.ciede2000_vs_reference.mean"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('angular_error_vs_original')" pSortableColumn="metrics.angular_error_vs_original.mean">Angular Error vs Orig (Avg) â†“ <p-sortIcon field="metrics.angular_error_vs_original.mean"></p-sortIcon></th>
            <th *ngIf="hasMetricColumn('angular_error_vs_reference')" pSortableColumn="metrics.angular_error_vs_reference.mean">Angular Error vs Ref (Avg) â†“ <p-sortIcon field="metrics.angular_error_vs_reference.mean"></p-sortIcon></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-metric>
          <tr>
            <td>{{ metric.model }}</td>
            <td *ngIf="hasMetricColumn('niqe')">{{ metric.metrics.niqe !== undefined ? (metric.metrics.niqe | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('brisque')">{{ metric.metrics.brisque !== undefined ? (metric.metrics.brisque | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('loe')">{{ metric.metrics.loe !== undefined ? (metric.metrics.loe | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('psnr')">{{ metric.metrics.psnr !== undefined ? (metric.metrics.psnr | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('ssim')">{{ metric.metrics.ssim !== undefined ? (metric.metrics.ssim | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('lpips')">{{ metric.metrics.lpips !== undefined ? (metric.metrics.lpips | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('delta_e76_vs_original')">{{ metric.metrics.delta_e76_vs_original?.mean !== undefined ? (metric.metrics.delta_e76_vs_original.mean | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('delta_e76_vs_reference')">{{ metric.metrics.delta_e76_vs_reference?.mean !== undefined ? (metric.metrics.delta_e76_vs_reference.mean | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('ciede2000_vs_original')">{{ metric.metrics.ciede2000_vs_original?.mean !== undefined ? (metric.metrics.ciede2000_vs_original.mean | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('ciede2000_vs_reference')">{{ metric.metrics.ciede2000_vs_reference?.mean !== undefined ? (metric.metrics.ciede2000_vs_reference.mean | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('angular_error_vs_original')">{{ metric.metrics.angular_error_vs_original?.mean !== undefined ? (metric.metrics.angular_error_vs_original.mean | number:'1.4-4') : 'N/A' }}</td>
            <td *ngIf="hasMetricColumn('angular_error_vs_reference')">{{ metric.metrics.angular_error_vs_reference?.mean !== undefined ? (metric.metrics.angular_error_vs_reference.mean | number:'1.4-4') : 'N/A' }}</td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  </div>

  <div class="metrics-loading" *ngIf="loading">
    <p>Loading metrics data...</p>
  </div>

  <div class="metrics-empty" *ngIf="!loading && metrics.length === 0">
    <p>No metrics data available.</p>
  </div>
</div>
